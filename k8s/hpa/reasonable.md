
# vim 技巧


\[ \text{desiredReplicas} = \left\lceil 2 \times \left( \frac{40}{80} \right) \right\rceil = \left\lceil 1 \right\rceil = 1 \]


$$ \text{desiredReplicas} = \left\lceil \text{currentReplicas} \times \left( \frac{\text{currentMetricValue}}{\text{desiredMetricValue}} \right) \right\rceil $$



在 VI 编辑器中，您可以使用替换命令来完成这个任务。以下是具体的操作步骤：
首先，确保您处于命令模式（按 ESC 键可以进入命令模式）。
输入以下命令来替换 
```bash
第一次替换
:%s/\\\[/$$/g
第二次替换
:%s/\\\]/$$$/g
发现行末尾会多一个$
要删除行末的 $ 符号，您可以在 Vim 中使用以下命令
:%s/\$$//g
```


: 进入命令行模式
% 表示对整个文件进行操作
s 是替换命令
/\\$$/ 是要查找的模式（注意需要对 \ 进行转义）
$$/ 是替换后的文本
g 表示全局替换（替换所有匹配项）


# HPA summary 



结论:
1. 设定目标内存利用率**：80% 如果您希望从3个副本缩容到2个副本，当前指标需要达到53%的内存利用率。从2个
副本扩容到3个副本，当前指标需要达到88%的内存利用率。
2. 设定目标内存利用率**：85% 如果您希望从3个副本缩容到2个副本，当前指标需要达到56%的内存利用率。从2个
副本扩容到3个副本，当前指标需要达到93.5%的内存利用率。
3. 设定目标内存利用率**：90% 如果您希望从3个副本缩容到2个副本，当前指标需要达到60%的内存利用率。
从2个副本扩容到3个副本，当前指标需要达到99%的内存利用率。


假设我们的内存上线是
2048MiB 
那么
2048 * 0.88 = 1792MiB
2048 * 0.53 = 1088MiB
2048 * 0.60 = 1228MiB
2048 * 0.56 = 1136MiB
2048 * 0.93 = 1904MiB 这种占用率在我的环境中已经存在 
2048 * 0.95 = 1936MiB
2048 * 0.99 = 2023MiB


所以如果我们设定目标内存利用率是 85%
那么从3个副本缩容到2个副本，当前指标需要达到56%的内存利用率。
从2个副本扩容到3个副本，当前指标需要达到93.5%的内存利用率。
这个值看起来比较合理.

所以如果我们设定目标内存利用率是 80%
那么从3个副本缩容到2个副本，当前指标需要达到53%的内存利用率。
从2个副本扩容到3个副本，当前指标需要达到88%的内存利用率。
这个值看起来也还可以.但是内存的利用率好像不好trigger到53%.这个也就是环境能跟目前一般好像运行在59%



Horizontal Pod Autoscaler
公式如下:
ceil[currentReplicas * (currentMetricValue / desiredMetricValue)]
ceil(当前副本数 * (当前指标值 / 目标指标值))
我现在的问题如下:

如果我这么设置 HPA的内存
```yaml
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

从2个副本扩容到3个副本的条件 88%
- **当前副本**：2
- **设定目标内存利用率**：80%
- **扩容条件**：80% * 1.1 = 88%
具体公式如下：
ceil(当前副本数 * (当前指标值 / 目标指标值))
ceil(2 * (88% / 80%)) = ceil(2 * 1.1) = 3
所以，从2个副本扩容到3个副本的条件是88%。

从3个副本缩容到2个副本的条件 53%
- **当前副本**：3
- **设定目标内存利用率**：80%
- **缩容条件**：80% * 0.9 = 72%
具体公式如下：
ceil(当前副本数 * (当前指标值 / 目标指标值))
ceil(3 * (53% / 80%)) = ceil(3 * 0.667) = 2
所以，从3个副本缩容到2个副本的条件是53%。

1 我确认上面的公式和结论都是正确的
2 我的问题是,如果设置为利用率为80%的内存,那么从3个副本要缩放到2个副本当前指标要达到53%才可以,
这个值对于我的环境来说有些太低了.
- 90% HPA 
```
所以1 
我尝试增大这个值
设置我设置的内存利用率是90%的HPA,从3个副本缩放到2个副本
当前副本数：3
设定目标内存利用率：90%
缩容条件：90% * 0.9 = 81%
具体公式如下：
ceil(当前副本数 * (当前指标值 / 目标指标值))
ceil(3 * (60% / 90%)) = ceil(3 * 0.667) = 2
所以，从3个副本缩容到2个副本的条件是60%。
上面这个数据看起来比较对缩容比较合理.但是扩容起来就比较麻烦了

我们看下扩容的
设置我设置的内存利用率是90%的HPA,从2个副本扩容到3个副本
当前副本数：2
设定目标内存利用率：90%
扩容条件：90% * 1.1 = 99%
具体公式如下：
ceil(当前副本数 * (当前指标值 / 目标指标值))
ceil(2 * (99% / 90%)) = ceil(2 * 1.1) = 3
所以，从2个副本扩容到3个副本的条件是99%。
这个值对于我的环境来说有些太高了,所以我想把扩容的值降低到85%.
```
- 85% HPA
```
3 我尝试减小这个值
设置我设置的内存利用率是85%的HPA,从3个副本缩放到2个副本
当前副本数：3
设定目标内存利用率：85%
缩容条件：85% * 0.9 = 76.5%
具体公式如下：
ceil(当前副本数 * (当前指标值 / 目标指标值))
ceil(3 * (56% / 85%)) = ceil(3 * 0.667) = 2
所以，从3个副本缩容到2个副本的条件是56%。

现在看下如果我设置的内存利用率是85%的HPA,从2个副本扩容到3个副本
当前副本数：2
设定目标内存利用率：85%
扩容条件：85% * 1.1 = 93.5%
具体公式如下：
ceil(当前副本数 * (当前指标值 / 目标指标值))
ceil(2 * (93.5% / 85%)) = ceil(2 * 1.1) = 3
所以，从2个副本扩容到3个副本的条件是93.5%。
设置我设置的内存利用率是85%的HPA,从3个副本缩放到2个副本
```
- 86% HPA
```
如果我设置的内存利用率是86%的HPA,从2个副本扩容到3个副本
当前副本数：2
设定目标内存利用率：86%
扩容条件：86% * 1.1 = 95.6%
具体公式如下：
ceil(当前副本数 * (当前指标值 / 目标指标值))
ceil(2 * (95.6% / 86%)) = ceil(2 * 1.1) = 3
所以，从2个副本扩容到3个副本的条件是95.6%。



如果我设置的内存利用率是86%的HPA,从3个副本缩放到2个副本
当前副本数：3
设定目标内存利用率：86%
缩容条件：86% * 0.9 = 76.4%
具体公式如下：
ceil(当前副本数 * (当前指标值 / 目标指标值))
ceil(3 * (57% / 86%)) = ceil(3 * 0.667) = 2
所以，从3个副本缩容到2个副本的条件是57%。
```

- 75% HPA
```
2 我尝试减小这个值.最终结果看起来更不好
设置我设置的内存利用率是75%的HPA,从3个副本缩放到2个副本
当前副本数：3
设定目标内存利用率：75%
缩容条件：75% * 0.9 = 67.5%
具体公式如下：
ceil(当前副本数 * (当前指标值 / 目标指标值))
ceil(3 * (50% / 75%)) = ceil(3 * 0.667) = 2
所以，从3个副本缩容到2个副本的条件是低于50%。
```

3 ==> 2 的比例条件
```bash
我们知道
3 * 0.6625 = 1.9875
那么我想得到一组数字比如,3 * (A/B) = 1.9875
我想要一组A/B 都是小于100的整数 可能给我列出一些. 比如A=56/85
其实我期待的是B-A的数值能够最小,也就是A和B的数据最接近,且A/B 更接近0.6625
以下是一些可能的组合：
A = 66, B = 100
66/100 = 0.66
B - A = 34
A = 65, B = 98
65/98 ≈ 0.6633
B - A = 33
A = 64, B = 97
64/97 ≈ 0.6598
B - A = 33
A = 63, B = 95
63/95 ≈ 0.6632
B - A = 32
A = 62, B = 94
62/94 ≈ 0.6596
B - A = 32
A = 61, B = 92
61/92 ≈ 0.6630
B - A = 31
A = 60, B = 91
60/91 ≈ 0.6593
B - A = 31
A = 59, B = 89
59/89 ≈ 0.6629
B - A = 30
A = 58, B = 88
58/88 ≈ 0.6591
B - A = 30
A = 57, B = 86
57/86 ≈ 0.6628 ====〉 看起来往下走的这个区间更好一些
B - A = 29
这些组合都满足您的要求：A 和 B 都小于 100，它们的比值接近 0.6625，并且我已经按照 B-A 的差值从小到大排序。其中，A=57, B=86 的组合可能是最符合您期望的，因为它们的差值最小（29），且比值 0.6628 非常接近 0.6625。
```


